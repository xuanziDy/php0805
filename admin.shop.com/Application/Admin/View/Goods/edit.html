<extend name="Common:edit"/>
<block name="css">
    <link href="__ZTREE__/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" type="text/css"/>
    <link href="__UPLOADIFY__/uploadify.css" rel="stylesheet" type="text/css"/>
    <style type="text/css">
        .upload-pre-item{
            position:relative;
            margin-right:10px;
        }
        .upload-pre-item a{
            position:absolute;
            top:0px;
            right:0px;
            width:15px;
            height:15px;
            text-align:center;
            background: white;
            color:red;
        }
    </style>
</block>
<block name="form">
    <div id="tabbar-div">
        <p>
            <span class="tab-front">通用信息</span>
            <span class="tab-back">商品描述</span>
            <span class="tab-back">会员价格</span>
            <span class="tab-back">商品属性</span>
            <span class="tab-back">商品相册</span>
            <span class="tab-back">关联文章</span>
        </p>
    </div>
    <form method="post" action="{:U()}">
        <!--通用信息-->
        <table cellspacing="1" cellpadding="3" width="100%">
            <tr>
                <td class="label">商品名称</td>
                <td>
                    <input type="text" name="name" maxlength="60" value="{$name}"> <span class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">商品分类</td>
                <td>
                    <input type="hidden" name="goods_category_id" class="goods_category_id" maxlength="60">
                    <input type="text" name="goods_category_text" class="goods_category_text" maxlength="60"
                           disabled="disabled">
                </td>
            </tr>
            <tr>
                <td class="label"></td>
                <td>
                    <ul id="treeDemo" class="ztree"></ul>
                </td>
            </tr>
            <tr>
                <td class="label">商品品牌</td>
                <td>
                    {:arr2selected('brand_id',$brands,$brand_id)}
                    <span class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">商品供货商</td>
                <td>
                    {:arr2selected('supplier_id',$suppliers,$supplier_id)}
                    <span class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">本店价格</td>
                <td>
                    <input type="text" name="shop_price" maxlength="60" value="{$shop_price}"> <span
                        class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">市场价格</td>
                <td>
                    <input type="text" name="market_price" maxlength="60" value="{$market_price}"> <span
                        class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">库存</td>
                <td>
                    <input type="text" name="stock" maxlength="60" value="{$stock}"> <span class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">是否上架</td>
                <td>
                    <input type="radio" name="is_on_sale" class="is_on_sale" value="1"/>是
                    <input type="radio" name="is_on_sale" class="is_on_sale" value="0"> 否
                    <span class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">商品状态</td>
                <td>
                    <input type="checkbox" name="goods_status[]" class="goods_status" value="1"/>疯狂抢购
                    <input type="checkbox" name="goods_status[]" class="goods_status" value="2"/> 热卖商品
                    <input type="checkbox" name="goods_status[]" class="goods_status" value="4"/>推荐商品
                    <input type="checkbox" name="goods_status[]" class="goods_status" value="8"/>新品上架
                    <input type="checkbox" name="goods_status[]" class="goods_status" value="16"/>猜您喜欢
                    <span class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">关键字</td>
                <td>
                    <input type="text" name="keyword" maxlength="60" value="{$keyword}"> <span
                        class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">品牌LOGO</td>
                <td>
                    <input type="file" name="upload-logo" id="upload-logo"/>
                    <input type="hidden" class="logo" name="logo" value="{$logo}">

                    <div class="upload-img-box upload-goods-box" style="display: {$logo?'block':'none'}">
                        <div class="upload-pre-item">
                            <img src="/Uploads/{$logo}">
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label">是否显示</td>
                <td>
                    <input type="radio" name="status" class="status" value="1"/>是
                    <input type="radio" name="status" class="status" value="0"> 否
                    <span class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td class="label">排序</td>
                <td>
                    <input type="text" name="sort" maxlength="60" value="{$sort|default=10}">
                    <span class="require-field">*</span>
                </td>
            </tr>
        </table>
        <!--商品描述-->
        <table cellspacing="1" cellpadding="3" width="100%" style="display: none">
            <tr>
                <td>
                    <textarea name="intro" id="intro">{$intro}</textarea>
                </td>
            </tr>
        </table>
        <!--会员价格-->
        <table cellspacing="1" cellpadding="3" width="100%" style="display: none">
            <volist name="memberLevels" id="memberLevel">
                <tr>
                    <td class="label">{$memberLevel.name}</td>
                    <td>
                        <input type="text" name="memberPrice[{$memberLevel.id}]" maxlength="60" value="{$prices[$memberLevel['id']]}">
                        <span  class="require-field">*</span>
                    </td>
                </tr>
            </volist>
        </table>
        <!--商品属性-->
        <table cellspacing="1" cellpadding="3" width="100%" style="display: none">
            <tr>
                <td class="label">商品类型</td>
                <td>
                    {:arr2selected('goods_type_id',$goodsTypes,$goods_type_id)}
                   <span  class="require-field">*</span>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <hr/>
                </td>
            </tr>
            <tbody id="attributeForm"></tbody>
        </table>
        <!--商品相册-->
        <table cellspacing="1" cellpadding="3" width="100%" style="display: none">
            <tr>
                <td>
                    <div class="upload-img-box upload-album-box">
                        <volist name="albums" id="album">
                            <div class="upload-pre-item" style="display: inline-block">
                                <img src="/Uploads/{$album.path}">
                                <a albumId="{$album.id}" href="javascript:;">X</a>
                            </div>
                        </volist>
                    </div>
                </td>
            </tr>
            <tr>
                <td><input type="file" name="upload-album" id="upload-album"></td>
            </tr>
        </table>
        <!--关联文章-->
        <table cellspacing="1" cellpadding="3" width="100%" style="display: none">
            <tr>
                <td>文章搜索：<input type="text" name="title" class="title" maxlength="60" ><input type="button" class="search" value="搜索"></td>

            </tr>
            <tr>
                <td style="width:500px;">
                    <select name="left_select" class="left_select" multiple="multiple" style="width:100%;height:500px;">

                    </select>
                </td>
                <td style="width:500px;">
                    <div class="optionHidden">
                        <volist name="articles" id="article">
                            <input type="hidden" name="article_id[]" value="{$article.id}">
                        </volist>
                    </div>
                    <select name="right_select" class="right_select" multiple="multiple" style="width:100%;height:500px;">
                        <volist name="articles" id="article">
                            <option value="{$article.id}">{$article.name}</option>
                        </volist>

                    </select>
                </td>
            </tr>
        </table>

        <div style="text-align: center">
            <input type="hidden" name="id" value="{$id}"/>
            <input type="submit" class="button ajax-post_1" value=" 确定 "/>
            <input type="reset" class="button" value=" 重置 "/>
        </div>
    </form>
</block>

<block name="js">
    <script type="text/javascript" src="__ZTREE__/js/jquery.ztree.core-3.5.js"></script>
    <script type="text/javascript" src="__UPLOADIFY__/jquery.uploadify.js"></script>
    <script type="text/javascript" charset="utf-8" src="__UEDITOR__/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="__UEDITOR__/ueditor.all.min.js"></script>
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="__UEDITOR__/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript">
        $(function () {
            //================================切换选项  开始==========================================//
            $('#tabbar-div span').click(function () {
                //改变选中项的样式
                $('#tabbar-div span').removeClass().addClass('tab-back');
                $(this).removeClass().addClass('tab-front');
                //显示对应的选中项的table
                $('form>table').hide();
                var index = $(this).index();
                $('form>table').eq(index).show();
                //当点击【商品描述】时，才加载编辑器
                if (index == 1) {
                    UE.getEditor('intro');
                }
            });
            //================================切换选项  结束==========================================//
            //================================默认值 开始============================================//
            $('.status').val([{$status|default=1}]);      //>>是否显示，必须是数组，才能让单选框选中
            $('.is_on_sale').val([{$is_on_sale|default=1}]);  //>>是否上架
            //================================默认值  结束===========================================//
            //================================商品分类   开始========================================//
            //>>1.树的设置
            var setting = {
                data: {
                    simpleData: {
                        enable: true,
                        pIdKey: "parent_id",
                    }
                },
                callback: {
                    beforeClick: function (treeId, treeNode, clickFlag) {
                        return !treeNode.isParent;  //是父节点整体结果就返回false,然后就不会选中节点
                    },
                    onClick: function (event, treeId, treeNode) {
                        //第三个参数会得到当前单击的对象
                        console.debug(treeNode);
                        $('.goods_category_text').val(treeNode.name);
                        $('.goods_category_id').val(treeNode.id);
                    }
                }
            };
            //>>2.(这里是json形式的数组)，准备树中需要的数据
            var zNodes = {$nodes};
            //>>3.将id为treeDemo的ul变成一个树，返回值是该对象。
            var treeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
            <notempty name = "id" >
            //>>4.编辑页面不全部显示节点，数据回显
            var goods_category_id = {$goods_category_id};
            var node = treeObj.getNodeByParam('id', goods_category_id);
            if (!node) {
                return;
            }
            treeObj.selectNode(node); //选中该节点
            $('.goods_category_id').val(node.id);
            $('.goods_category_text').val(node.name);
            <else/>
            //>>5.添加页面，所有节点展开
            treeObj.expandAll(true);
            </notempty>

                //==================================商品分类   结束========================================//
                //==================================文件上传   开始========================================//
                //由于是一个flash显示的插件，加载需要插件，如果出现浏览器崩溃情况，可以用一个定时器让页面加载完之后一点时间在显示。
            window.setTimeout(function () {
                $("#upload-logo").uploadify({
                    height: 25,    //指定删除插件的高和宽
                    width: 145,
                    swf: '__UPLOADIFY__/uploadify.swf',   //指定swf的地址
                    uploader: '{:U("Uploader/index")}',  //在服务器上处理上传的代码
                    'buttonText': '选择图片',            //上传按钮上面的文字
                    'fileSizeLimit': '100KB',             //限制大小
                    'formData': {'dir': 'goods'},       //通过post方式传递的额外参数,空间的名字
                    'multi': false,                      //是否支持多文件上传
                    'onUploadSuccess': function (file, data, response) {    //上传成功时执行的方法
                        $('.logo').val(data);          //把上传的图片；路径给隐藏域。
                        $('.upload-img-box').show();   //显示隐藏的div
                        $('.upload-goods-box img').attr('src', "/Uploads/" + data);     //本地图片的显示路径
                    },

//                    $('.upload-goods-box img').attr('src',"__YPYUN__/"+data);     //云上图片的显示路径

                    'onUploadError': function (file, errorCode, errorMsg, errorString) {    //上传失败时该方法执行
                        alert('该文件上传失败!错误信息为:' + errorString);
                    }
                });
            }, 10);
            /*==================================文件上传   结束========================================*/
            /*==================================商品状态回显   开始========================================*/
            <notempty name = "id" >
            var goods_status = {$goods_status}; //商品状态
            var goods_status_value = new Array();  //js中初始化数组
            if ((goods_status & 1) == 1) {      //这里最好是用括号括起来
                goods_status_value.push(1);  //把1放入数组
            }
            if ((goods_status & 2) == 2) {
                goods_status_value.push(2);
            }
            if ((goods_status & 4) == 4) {
                goods_status_value.push(4);
            }
            if ((goods_status & 8) ==8) {
                goods_status_value.push(8);
            }
            if ((goods_status & 16) == 16) {
                goods_status_value.push(16);
             }
            $('.goods_status').val(goods_status_value); //选中
            </notempty >
            /*==================================商品状态回显   结束========================================*/
            /*==================================商品相册上传   开始========================================*/
            window.setTimeout(function () {
                $("#upload-album").uploadify({
                    height: 25,    //指定删除插件的高和宽
                    width: 145,
                    swf: '__UPLOADIFY__/uploadify.swf',                          //指定swf的地址
                    uploader: '{:U("Uploader/index")}',                               //在服务器上处理上传的代码
                    'buttonText': '选择图片',                                              //上传按钮上面的文字
                    'fileSizeLimit': '100KB',                                              //限制大小
                    'formData': {'dir': 'goods'},                                    //通过post方式传递的额外参数,空间的名字
                    'multi': true,                                                      //是否支持多文件上传
                    'onUploadSuccess': function (file, data, response) {                    //上传成功时执行的方法
                       //上传成功就是把展示图片的代码追加到td中,并增加隐藏域保存图片路径
                        var html='<div class="upload-pre-item" style="display:inline-block">\
                                        <img src="/Uploads/'+data+'">\
                                        <a href="javascript:;">X</a>\
                                        <input type="hidden" name="upload_album_path[]" class="upload_album_path" value="'+data+'"/>\
                                </div>';
                        $('.upload-album-box').append(html);
                    },
                    'onUploadError': function (file, errorCode, errorMsg, errorString) {    //上传失败时该方法执行
                        alert('该文件上传失败!错误信息为:' + errorString);
                    }
                });
            }, 10);

            //编辑时，删除上传的相册图片
            $('.upload-album-box').on('click','a',function(){
                var albumId=$(this).attr('albumId');
                if(albumId){
                    //不是新上传(有albumId)--删除数据库中数据及页面节点
                    var aa=$(this);
                    $.post('{:U("deleteGoodsAlbum")}',{"album_id":albumId},function(data){
                        if(data.success){
                            //库中删除成功,删除页面节点
                            aa.closest('div').remove();
                        }
                    });
                }else{
                    //新上传--删除页面节点
                    $(this).closest('div').remove();
                }

            });
        /*==================================商品相册上传   结束=======================================*/
        /*==================================关联文章   开始=======================================*/
        //>>给搜索按钮绑定单击事件，把class=title中的内容发送ajax去服务器，模糊查询得到一系列标题，存放在left-serach框里面。
        $('.search').click(function(){
            var title=$('.title').val();
            $('.left_select').empty(); //清空数据
            if(title){   //有值
                $.getJSON('{:U("Article/search")}',{"title":title},function(data){
                    var optionHtml="";
                    $(data).each(function(){
                        optionHtml += "<option value='"+$(this)[0].id+"'>"+$(this)[0].name+"</option><br/>";
                    });
                    $('.left_select').append(optionHtml);
                });
            }

        });

        //给class=title的搜索框绑定键盘事件，回车的时候就阻止默认提交事件
        $('.title').keypress(function(event){
            if(event.charCode==13){   //键值charcode
                return false;
            }
        });
        //左边<=>右边
        $('.left_select').on('dblclick','option',function(){
            $(this).appendTo('.right_select');
            //为每个option添加隐藏域，用来保存每个文章的id
            select2Hidden();
        });
        $('.right_select').on('dblclick','option',function(){
            $(this).appendTo('.left_select');
            select2Hidden();
        });
        function select2Hidden(){
            var hiddenHtml="";
            $('.right_select option').each(function(){
                //这里this代表每个option节点
                hiddenHtml+="<input type='hidden' name='article_id[]' value='"+this.value+"'/>";
            });
            $('.optionHidden').empty();  //在加入div之前，先把盒子清空
            $('.optionHidden').append(hiddenHtml);
        }
        //对于下拉框而言，只有选中的才会提交。

        /*==================================关联文章   结束=======================================*/
        /*================================== 属性的开始  =======================================*/
            $('.goods_type_id').change(function(){
                var goods_type_id = $(this).val();
                if(!goods_type_id){  //选择了  请选择..    不用发送ajax请求
                    return false;
                }

                $.getJSON('{:U("Attribute/getByGoodsTypeId")}',{goods_type_id:goods_type_id},function(rows){
                      buildAttributeForm(rows);
                });
            });

            /***
             * 根据rows中的值 生成 不同的属性以及对应的表单元素
             * @param rows
             *      属性类型         录入方式           生成的表单元素
             *       单值==1         手工录入=1            <input type='text'
             *       单值==1         从列表中选择=2        <select>.... option使用可选值生成
             *       单值==1         多行文本=3            <textarea...
             *       多值==2         从列表中选择=2         复选框   . 复选框中的值使用  可选值 生成...
             */
            function buildAttributeForm(rows){
                var html = '';
                 $(rows).each(function(){
                     html+='<tr>';
                        html+="<td class='label'>"+this.name+"</td>";//生成属性的名字
                        html+="<td>"
                          //第二个列中根据属性的类型和录入方式生成不同的表单元素
                            if(this.attribute_type==1){ //当属性的单值的情况
                                switch(parseInt(this.attribute_input_type)){  //this.attribute_input_type是一个字符串,必须进行转换数字再进行比对
                                    case 1:  // 单行文本
                                        html+="<input name='goodsAttribute["+this.id+"]' type='text'>"; break;
                                    case 2:  // 下拉列表
                                        var selectHtml = "<select name='goodsAttribute["+this.id+"]'>";
                                            $(this.option_values).each(function(){ //使用可选值生成下拉框中的数据
                                                selectHtml += "<option value='"+this+"'>"+this+"</option>";
                                            });
                                            selectHtml += "</select>";
                                        html+=selectHtml;
                                        break;
                                    case 3:  // 多行文本
                                        html+="<textarea name='goodsAttribute["+this.id+"]'></textarea>";
                                        break;
                                }
                            }else{
                                //多值的情况下根据可选值生成复选框
                                var that = this;  //每一个属性
                                $(this.option_values).each(function(){
                                    html+= ("<input  name='goodsAttribute["+that.id+"][]' type='checkbox' value='"+this+"'>"+this);
                                });
                            }

                        html+="</td>";
                     html+='</tr>';
                 });
                $('#attributeForm').empty();  //先清除在添加
                $('#attributeForm').append(html);
            }

            <notempty name='id'>
                    //>>1.编辑的时候准备属性表单元素
                    var attributes = {$attributes};
                    buildAttributeForm(attributes);
                   //>>2.要为表单元素赋值
                   var goodsAttributes = {$goodsAttributes};
                    for(var i in  goodsAttributes){
                        console.debug(goodsAttributes[i]);
                        $(':input[name^="goodsAttribute['+i+']"]').val(goodsAttributes[i]);
                    }
            </notempty>
            /////////////////////////////属性的结束   ////////////////////////////////////////////
        });
    </script>
</block>